<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Core Explorer - V7.6 Deep Space Analyst</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;500;700&family=Share+Tech+Mono&display=swap');

        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --alert-red: #ff2a2a;
            --holo-green: #00ffaa;
            --gold: #ffd700;
            --glass-bg: rgba(5, 8, 15, 0.9);
            --border-color: rgba(0, 243, 255, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }

        body {
            background-color: #000; color: #fff; font-family: 'Rajdhani', sans-serif; overflow: hidden;
            cursor: default;
        }

        #webgl-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }

        /* --- CONTEXT MENU (GELƒ∞≈ûMƒ∞≈û) --- */
        #context-menu {
            position: fixed; z-index: 1000; display: none; width: 240px;
            background: rgba(8, 12, 24, 0.98); border: 1px solid var(--neon-blue);
            box-shadow: 0 0 25px rgba(0, 243, 255, 0.2); backdrop-filter: blur(10px);
            animation: menuOpen 0.15s ease-out;
            border-radius: 4px;
        }
        @keyframes menuOpen { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .ctx-header {
            padding: 12px; background: linear-gradient(90deg, rgba(0, 243, 255, 0.1), transparent); 
            color: var(--neon-blue); font-family: 'Share Tech Mono'; font-size: 0.85rem; 
            border-bottom: 1px solid var(--border-color); letter-spacing: 2px;
        }
        .ctx-item {
            padding: 12px 20px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; 
            border-left: 3px solid transparent; color: #ccc; display: flex; align-items: center; gap: 10px;
        }
        .ctx-item:hover { background: rgba(255, 255, 255, 0.05); border-left: 3px solid var(--holo-green); color: #fff; }
        .ctx-item.danger:hover { border-left: 3px solid var(--alert-red); color: var(--alert-red); }
        .ctx-icon { font-size: 1.1rem; width: 20px; text-align: center; }

        /* UI Katmanƒ± */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
            pointer-events: none; padding: 20px;
            background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.4) 100%);
            transition: opacity 0.5s, visibility 0.5s;
        }
        body.cinema-mode #ui-layer { opacity: 0; visibility: hidden; pointer-events: none; }

        /* G√∂z Butonu */
        #global-toggle-btn {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(0, 0, 0, 0.6); border: 1px solid var(--neon-blue); color: var(--neon-blue);
            width: 45px; height: 45px; border-radius: 50%; font-size: 1.4rem;
            cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); backdrop-filter: blur(5px);
        }
        #global-toggle-btn:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 30px var(--neon-blue); }

        /* Paneller */
        .hud-panel {
            background: var(--glass-bg); backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1); padding: 15px;
            position: absolute; pointer-events: auto;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        }
        .hud-panel:hover { border-color: var(--neon-blue); box-shadow: 0 0 40px rgba(0, 243, 255, 0.3); }

        /* Saƒü √úst */
        .top-right { top: 80px; right: 30px; text-align: right; width: 300px; } 
        .top-right h1 { font-size: 2.5rem; color: var(--neon-blue); margin-bottom: 0; text-shadow: 0 0 15px var(--neon-blue); line-height: 1; }
        .top-right .subtitle { font-family: 'Share Tech Mono', monospace; color: var(--neon-purple); font-size: 0.8rem; letter-spacing: 3px; }

        /* G√∂rev Paneli */
        .top-center-mission {
            top: 30px; left: 50%; transform: translateX(-50%); width: 420px;
            border-top: 3px solid var(--gold); text-align: center;
        }
        .mission-header { color: var(--gold); font-weight: bold; letter-spacing: 2px; font-size: 0.9rem; margin-bottom: 5px; }
        .mission-text { font-family: 'Share Tech Mono'; font-size: 1rem; color: #fff; text-shadow: 0 0 5px var(--gold); }
        .mission-xp { font-size: 0.8rem; color: #888; margin-top: 5px; }

        /* Tarayƒ±cƒ± */
        .top-left-scanner { top: 30px; left: 30px; width: 280px; border-left: 4px solid var(--neon-purple); }
        .scanner-title { color: var(--neon-purple); font-weight: bold; letter-spacing: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; padding-bottom: 5px; font-size: 1.1rem; }
        .scanner-data { font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; color: #ccc; line-height: 1.6; }
        .scanner-row { display: flex; justify-content: space-between; border-bottom: 1px dashed rgba(255,255,255,0.1); }
        .scanner-val { color: var(--neon-blue); }
        .target-locked { 
            color: var(--alert-red); border: 1px solid var(--alert-red); padding: 5px; background: rgba(255,0,0,0.1);
            font-weight: bold; text-align: center; margin-top: 15px; opacity: 0; transition: opacity 0.2s; 
            text-shadow: 0 0 5px red; font-size: 0.9rem;
        }

        /* Alt Kontroller */
        .bottom-center { bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; align-items: center; padding: 15px 30px; width: auto; justify-content: center; }
        .control-group-label { position: absolute; top: -10px; left: 10px; font-size: 0.7rem; color: rgba(255,255,255,0.5); background: var(--glass-bg); padding: 0 5px; }
        .control-group { display: flex; gap: 5px; border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; position: relative; }
        .control-btn { background: rgba(0, 243, 255, 0.05); border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 8px 15px; font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; cursor: pointer; text-transform: uppercase; transition: 0.3s; letter-spacing: 1px; }
        .control-btn:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        .control-btn.active { background: var(--alert-red); border-color: var(--alert-red); color: #fff; box-shadow: 0 0 20px var(--alert-red); }
        .control-btn.mode-active { background: var(--holo-green); border-color: var(--holo-green); color: #000; font-weight: bold; box-shadow: 0 0 15px var(--holo-green); }

        /* Controls Help */
        .controls-help { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; color: rgba(255,255,255,0.5); text-align: center; letter-spacing: 1px; text-shadow: 0 0 2px #000; }

        /* Ses & G√∂rsel */
        .bottom-left { bottom: 30px; left: 30px; width: 240px; }
        .audio-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .audio-label { font-size: 0.8rem; color: var(--holo-green); font-family: 'Share Tech Mono'; }
        #btn-mute { background: transparent; border: 1px solid var(--holo-green); color: var(--holo-green); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        #btn-mute:hover { background: var(--holo-green); color: #000; }
        #btn-mute.muted { border-color: var(--alert-red); color: var(--alert-red); }
        .visualizer { display: flex; align-items: flex-end; height: 30px; gap: 4px; }
        .bar { width: 100%; background: var(--holo-green); height: 5px; transition: height 0.05s; box-shadow: 0 0 5px var(--holo-green); }

        /* Terminal */
        .right-center-terminal { top: 50%; right: 30px; transform: translateY(-50%); width: 240px; height: 280px; display: flex; flex-direction: column; overflow: hidden; border-right: 2px solid var(--neon-blue); }
        .terminal-title { color: var(--neon-blue); font-size: 0.9rem; border-bottom: 1px solid var(--neon-blue); margin-bottom: 5px; font-weight: bold; }
        .terminal-content { flex-grow: 1; font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; color: rgba(255,255,255,0.7); overflow: hidden; display: flex; flex-direction: column-reverse; }
        .term-line { margin-bottom: 3px; opacity: 0.9; line-height: 1.2; }
        .term-line.highlight { color: var(--holo-green); font-weight: bold; }
        .term-line.analysis { color: var(--neon-blue); }
        .term-line.mission-update { color: var(--gold); font-weight: bold; border: 1px solid var(--gold); padding: 2px; margin: 5px 0; }

        /* Bildirim */
        #message-overlay { position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%); font-family: 'Share Tech Mono', monospace; font-size: 3rem; color: #fff; text-shadow: 0 0 30px var(--neon-blue); pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 5; text-align: center; letter-spacing: 5px; background: rgba(0,0,0,0.6); padding: 20px 40px; border: 1px solid var(--neon-blue); clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px); }

        /* Start Screen */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; transition: opacity 0.8s ease; }
        .start-btn { padding: 15px 50px; font-size: 1.2rem; background: rgba(0, 243, 255, 0.1); color: var(--neon-blue); border: 1px solid var(--neon-blue); font-family: 'Share Tech Mono', monospace; letter-spacing: 3px; cursor: pointer; margin-top: 30px; transition: 0.3s; position: relative; overflow: hidden; }
        .start-btn:hover { box-shadow: 0 0 50px rgba(0, 243, 255, 0.6); color: #fff; background: rgba(0, 243, 255, 0.2); }

    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- CONTEXT MENU (Dƒ∞NAMƒ∞K) -->
    <div id="context-menu">
        <div class="ctx-header" id="ctx-header-text">KOMUTA MEN√úS√ú</div>
        <!-- Yƒ±ldƒ±z Men√ºs√º -->
        <div id="ctx-star-options" style="display:none;">
            <div class="ctx-item" id="ctx-jump"><span class="ctx-icon">üöÄ</span> HYPER-JUMP</div>
            <div class="ctx-item" id="ctx-analyze"><span class="ctx-icon">üìä</span> YILDIZ ANALƒ∞Zƒ∞</div>
        </div>
        <!-- Bo≈üluk Men√ºs√º -->
        <div id="ctx-space-options" style="display:none;">
            <div class="ctx-item" id="ctx-scan-sector"><span class="ctx-icon">üì°</span> SEKT√ñR TARAMASI</div>
            <div class="ctx-item" id="ctx-mark-coord"><span class="ctx-icon">üìç</span> KOORDƒ∞NAT KAYDI</div>
        </div>
        <div class="ctx-item danger" id="ctx-cancel"><span class="ctx-icon">‚ùå</span> KAPAT</div>
    </div>

    <!-- KALICI G√ñZ BUTONU -->
    <button id="global-toggle-btn" title="Aray√ºz√º A√ß/Kapat">üëÅÔ∏è</button>

    <!-- Ba≈ülangƒ±√ß -->
    <div id="start-screen">
        <div style="text-align:center;">
            <h1 style="color:#fff; font-size:3rem; letter-spacing:5px; margin-bottom:10px; text-shadow:0 0 20px var(--neon-blue);">NEON HORIZONS</h1>
            <p style="color:var(--neon-purple); font-family:'Share Tech Mono'; font-size:1rem; letter-spacing:2px;">V7.6: DEEP SPACE ANALYST</p>
        </div>
        <button class="start-btn" id="btn-init">BAƒûLANTIYI KUR</button>
    </div>

    <!-- Bildirim -->
    <div id="message-overlay">WARP S√úR√ú≈û√ú AKTƒ∞F</div>

    <!-- WebGL -->
    <div id="webgl-container"></div>

    <!-- UI -->
    <div id="ui-layer">
        <!-- G√∂rev -->
        <div class="hud-panel top-center-mission">
            <div class="mission-header">AKTƒ∞F G√ñREV</div>
            <div class="mission-text" id="mission-desc">BEKLEMEDE...</div>
            <div class="mission-xp" id="player-rank">R√úTBE: ACEMƒ∞ Pƒ∞LOT</div>
        </div>

        <!-- Tarayƒ±cƒ± -->
        <div class="hud-panel top-left-scanner">
            <div class="scanner-title">TARAMA MOD√úL√ú</div>
            <div class="scanner-data">
                <div class="scanner-row"><span>HEDEF ID:</span> <span class="scanner-val" id="scan-id">---</span></div>
                <div class="scanner-row"><span>SINIF:</span> <span class="scanner-val" id="scan-class">BEKLEMEDE</span></div>
                <div class="scanner-row"><span>SICAKLIK:</span> <span class="scanner-val" id="scan-temp">0 K</span></div>
                <div class="scanner-row"><span>UZAKLIK:</span> <span class="scanner-val" id="scan-dist">0 IY</span></div>
                <div class="scanner-row" style="border:none; margin-top:5px;"><span>DURUM:</span> <span class="scanner-val" id="net-status" style="color:var(--holo-green)">PASƒ∞F</span></div>
            </div>
            <div class="target-locked" id="lock-msg">HEDEF Kƒ∞Lƒ∞TLENDƒ∞<br><span style="font-size:0.8em; color:#fff; font-weight:normal;">(Saƒü Tƒ±k: Men√º)</span></div>
        </div>

        <!-- Ba≈ülƒ±k -->
        <div class="hud-panel top-right">
            <h1>SAMANYOLU</h1>
            <div class="subtitle">V7.6 KOKPƒ∞T</div>
        </div>

        <!-- KONTROLLER -->
        <div class="hud-panel bottom-center">
            <div class="control-group">
                <span class="control-group-label">MOD</span>
                <button class="control-btn" id="btn-nav">NAVƒ∞GASYON</button>
                <button class="control-btn mode-active" id="btn-scan">TARA</button>
            </div>

            <div class="control-group">
                <span class="control-group-label">KAMERA</span>
                <button class="control-btn" id="btn-top">√úST</button>
                <button class="control-btn" id="btn-side">YAN</button>
                <button class="control-btn" id="btn-core">MERKEZ</button>
                <button class="control-btn" id="btn-free">SERBEST</button>
            </div>

            <div class="control-group" style="border:none;">
                <button class="control-btn" id="btn-warp" style="color:var(--gold); border-color:var(--gold);">WARP</button>
                <button class="control-btn" id="btn-hide">Gƒ∞ZLE</button>
            </div>
        </div>
        <div class="controls-help">SOL TIK: SE√á | SAƒû TIK: MEN√ú | S√úR√úKLE: D√ñND√úR</div>

        <!-- Ses & G√∂rsel -->
        <div class="hud-panel bottom-left">
            <div class="audio-controls">
                <div class="audio-label">
                    SES MOTORU<br>
                    <span id="audio-text" style="font-size:0.7rem;">BEKLEMEDE</span>
                </div>
                <button id="btn-mute">üîä</button>
            </div>
            <div class="visualizer" id="visualizer-container"></div>
        </div>

        <!-- Terminal -->
        <div class="hud-panel right-center-terminal">
            <div class="terminal-title">G√ñREV & ANALƒ∞Z KAYITLARI</div>
            <div class="terminal-content" id="terminal-out">
                <div class="term-line">Sistem hazƒ±r...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- Deƒüi≈ükenler ---
        let scene, camera, renderer, controls, composer;
        let galaxyPoints, nebulaPoints, bgStars;
        let warpStreaks, dustParticles, coreMesh, coreGlow;
        let raycaster, mouse;
        let connectionLines;
        let comets = [];

        // Durumlar
        let isWarping = false;
        let warpSpeed = 0;
        let currentMode = 'scan';
        let currentView = 'free';
        let targetCameraPos = new THREE.Vector3();
        let lockedTargetPos = null; // Kilitlenilen yƒ±ldƒ±zƒ±n pozisyonu
        let rightClickPos = null; // Saƒü tƒ±klanƒ±lan herhangi bir koordinat (bo≈üluk i√ßin)
        let isCinemaMode = false;
        
        // Ses
        let audioCtx, masterGain, droneOsc1, droneOsc2;
        let isAudioInitialized = false;
        let isMuted = false;

        // G√∂rev
        let currentMission = null;
        let playerRank = 1;
        const ranks = ["ACEMƒ∞ Pƒ∞LOT", "YILDIZ GEZGƒ∞Nƒ∞", "GALAKTƒ∞K KA≈ûƒ∞F", "UZAY EFSANESƒ∞"];

        // DOM
        const elScanId = document.getElementById('scan-id');
        const elScanClass = document.getElementById('scan-class');
        const elScanTemp = document.getElementById('scan-temp');
        const elScanDist = document.getElementById('scan-dist');
        const elNetStatus = document.getElementById('net-status');
        const elLockMsg = document.getElementById('lock-msg');
        const elOverlay = document.getElementById('message-overlay');
        const elAudioText = document.getElementById('audio-text');
        const elTerminal = document.getElementById('terminal-out');
        const elMissionDesc = document.getElementById('mission-desc');
        const elPlayerRank = document.getElementById('player-rank');
        const btnMute = document.getElementById('btn-mute');
        const ctxMenu = document.getElementById('context-menu');

        const params = {
            count: 90000,
            nebulaCount: 6000,
            warpStarCount: 2000,
            dustCount: 1500,
            size: 0.015,
            radius: 7,
            branches: 5,
            spin: 1.5,
            randomness: 0.3,
            randomnessPower: 3,
            insideColor: new THREE.Color('#ff6030'),
            outsideColor: new THREE.Color('#1b3984')
        };

        // --- SES MOTORU ---
        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.2;
            masterGain.connect(audioCtx.destination);

            droneOsc1 = audioCtx.createOscillator();
            droneOsc1.type = 'triangle';
            droneOsc1.frequency.value = 40;
            const gain1 = audioCtx.createGain();
            gain1.gain.value = 0.3;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 100;
            droneOsc1.connect(filter).connect(gain1).connect(masterGain);
            droneOsc1.start();

            droneOsc2 = audioCtx.createOscillator();
            droneOsc2.type = 'sine';
            droneOsc2.frequency.value = 120;
            const gain2 = audioCtx.createGain();
            gain2.gain.value = 0.1;
            droneOsc2.connect(gain2).connect(masterGain);
            droneOsc2.start();

            isAudioInitialized = true;
            updateAudioUI();
            setupVisualizer();
        }

        function toggleAudio() {
            if (!isAudioInitialized) return;
            if (audioCtx.state === 'running') {
                audioCtx.suspend();
                isMuted = true;
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
                isMuted = false;
            }
            updateAudioUI();
        }

        function updateAudioUI() {
            if (isMuted) {
                btnMute.innerText = "üîá";
                btnMute.classList.add('muted');
                elAudioText.innerText = "PASƒ∞F";
                elAudioText.style.color = "var(--alert-red)";
            } else {
                btnMute.innerText = "üîä";
                btnMute.classList.remove('muted');
                elAudioText.innerText = "AKTƒ∞F";
                elAudioText.style.color = "var(--holo-green)";
            }
        }

        function playSoundEffect(type) {
            if(!isAudioInitialized || isMuted || audioCtx.state !== 'running') return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain).connect(masterGain);
            const now = audioCtx.currentTime;

            if (type === 'scan') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'jump') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 1);
                osc.start(now); osc.stop(now + 1);
            } else if (type === 'success') {
                const o1 = audioCtx.createOscillator();
                const g1 = audioCtx.createGain();
                o1.connect(g1).connect(masterGain);
                o1.type = 'sine';
                o1.frequency.setValueAtTime(440, now); 
                o1.frequency.setValueAtTime(554, now + 0.1); 
                o1.frequency.setValueAtTime(659, now + 0.2); 
                g1.gain.setValueAtTime(0.1, now);
                g1.gain.linearRampToValueAtTime(0, now + 0.5);
                o1.start(now); o1.stop(now + 0.5);
            } else if (type === 'warp_start') {
                const oscW = audioCtx.createOscillator();
                const gainW = audioCtx.createGain();
                oscW.connect(gainW).connect(masterGain);
                oscW.type = 'sawtooth';
                oscW.frequency.setValueAtTime(50, now);
                oscW.frequency.exponentialRampToValueAtTime(400, now + 2);
                gainW.gain.setValueAtTime(0.2, now);
                gainW.gain.linearRampToValueAtTime(0, now + 2);
                oscW.start(now); oscW.stop(now + 2);
            } else if (type === 'sector_scan') {
                // D√º≈ü√ºk frekanslƒ± tarama sesi
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.5);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
        }

        function updateAudioEngine() {
            if(!isAudioInitialized || isMuted) return;
            const f1 = 40 + (warpSpeed * 80);
            const f2 = 120 + (warpSpeed * 200);
            droneOsc1.frequency.setTargetAtTime(f1, audioCtx.currentTime, 0.1);
            droneOsc2.frequency.setTargetAtTime(f2, audioCtx.currentTime, 0.1);
        }

        function setupVisualizer() {
            const container = document.getElementById('visualizer-container');
            container.innerHTML = '';
            for(let i=0; i<10; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                container.appendChild(bar);
            }
        }

        function animateVisualizer() {
            if(!isAudioInitialized || isMuted) return;
            const bars = document.querySelectorAll('.visualizer .bar');
            bars.forEach((bar, i) => {
                const h = (10 + (warpSpeed * 50)) + (Math.random() * 50);
                bar.style.height = Math.min(h, 100) + '%';
                bar.style.backgroundColor = isWarping ? '#ff2a2a' : '#00ffaa';
            });
        }

        // --- MOD VE KAMERA Y√ñNETƒ∞Mƒ∞ ---
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-nav').classList.remove('mode-active');
            document.getElementById('btn-scan').classList.remove('mode-active');
            
            if (mode === 'nav') {
                document.getElementById('btn-nav').classList.add('mode-active');
                lockedTargetPos = null;
                elLockMsg.style.opacity = 0;
            } else {
                document.getElementById('btn-scan').classList.add('mode-active');
            }
        }

        function setView(view) {
            currentView = view;
            ['top', 'side', 'core', 'free'].forEach(id => {
                const el = document.getElementById('btn-' + id);
                if(el) el.classList.remove('mode-active');
            });
            
            const activeBtn = document.getElementById('btn-' + view);
            if(activeBtn) activeBtn.classList.add('mode-active');

            if (view === 'top') {
                targetCameraPos.set(0, 16, 0);
            } else if (view === 'side') {
                targetCameraPos.set(16, 0, 0);
            } else if (view === 'core') {
                targetCameraPos.set(3, 1, 3);
            }
        }

        function toggleCinemaMode() {
            isCinemaMode = !isCinemaMode;
            if (isCinemaMode) document.body.classList.add('cinema-mode');
            else document.body.classList.remove('cinema-mode');
        }

        // --- THREE.JS INIT ---
        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.015);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            targetCameraPos.set(0, 10, 12);
            camera.position.copy(targetCameraPos);

            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.getElementById('webgl-container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 1;
            controls.maxDistance = 25;
            controls.enablePan = true;
            controls.screenSpacePanning = true;
            controls.mouseButtons = {
                LEFT: THREE.MOUSE.ROTATE,
                MIDDLE: THREE.MOUSE.DOLLY,
                RIGHT: THREE.MOUSE.PAN
            };

            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.1;
            bloomPass.strength = 2.0;
            bloomPass.radius = 0.5;

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            raycaster = new THREE.Raycaster();
            raycaster.params.Points.threshold = 0.2;
            mouse = new THREE.Vector2(999, 999);

            createGalaxy();
            createNebula();
            createBackgroundStars();
            createWarpStreaks();
            createSpaceDust();
            createGalacticCore();
            createConnections();
            initComets();

            window.addEventListener('resize', onResize);
            window.addEventListener('mousemove', onMouseMove);
            
            // Tƒ±klama Olaylarƒ±
            window.addEventListener('click', (e) => {
                // Men√ºy√º gizle
                ctxMenu.style.display = 'none';
                // Eƒüer canvasa tƒ±klandƒ±ysa se√ßim yap
                if (e.target.tagName === 'CANVAS') onMouseClick(e);
            });

            // CONTEXT MENU (Saƒü Tƒ±k)
            window.addEventListener('contextmenu', (e) => {
                e.preventDefault(); // Tarayƒ±cƒ± men√ºs√ºn√º engelle
                
                // Eƒüer canvas √ºzerindeysek
                if (e.target.tagName === 'CANVAS' && !isWarping) {
                    ctxMenu.style.display = 'block';
                    ctxMenu.style.left = e.clientX + 'px';
                    ctxMenu.style.top = e.clientY + 'px';

                    const starOptions = document.getElementById('ctx-star-options');
                    const spaceOptions = document.getElementById('ctx-space-options');
                    const headerText = document.getElementById('ctx-header-text');

                    // Tƒ±kladƒ±ƒüƒ±mƒ±z yerde bir yƒ±ldƒ±z var mƒ± kontrol et
                    // Mouse pozisyonunu g√ºncelle
                    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObject(galaxyPoints);

                    if(intersects.length > 0 && intersects[0].distanceToRay < 0.2) {
                        // YILDIZ MODU
                        headerText.innerText = "YILDIZ PROTOKOL√ú";
                        starOptions.style.display = 'block';
                        spaceOptions.style.display = 'none';
                        
                        // Kilitlenilen yƒ±ldƒ±z pozisyonunu g√ºncelle (eƒüer sol tƒ±klanmadƒ±ysa bile saƒü tƒ±kla se√ß)
                        const idx = intersects[0].index;
                        lockedTargetPos = new THREE.Vector3(
                            galaxyPoints.geometry.attributes.position.getX(idx),
                            galaxyPoints.geometry.attributes.position.getY(idx),
                            galaxyPoints.geometry.attributes.position.getZ(idx)
                        );
                    } else {
                        // BO≈ûLUK MODU
                        headerText.innerText = "SEKT√ñR KOMUTASI";
                        starOptions.style.display = 'none';
                        spaceOptions.style.display = 'block';
                        
                        // Bo≈üluk pozisyonu i√ßin basit bir Raycast d√ºzlemi hayal edebiliriz
                        // ≈ûimdilik sadece kameradan bir y√∂n vekt√∂r√º alƒ±yoruz
                        rightClickPos = new THREE.Vector3(0,0,0); // Placeholder
                    }
                }
            });

            // MEN√ú BUTONLARI
            document.getElementById('ctx-jump').onclick = () => {
                ctxMenu.style.display = 'none';
                if(lockedTargetPos) performHyperJump(lockedTargetPos);
            };
            document.getElementById('ctx-analyze').onclick = () => {
                ctxMenu.style.display = 'none';
                if(lockedTargetPos) {
                    logToTerminal(`YILDIZ ANALƒ∞Zƒ∞ BA≈ûLATILDI...`, 'analysis');
                    setTimeout(() => logToTerminal(`> K√úTLE: ${(Math.random()*5+0.5).toFixed(2)} G√ºne≈ü K√ºtlesi`), 500);
                    setTimeout(() => logToTerminal(`> YA≈û: ${(Math.random()*10).toFixed(1)} Milyar Yƒ±l`), 1000);
                    setTimeout(() => logToTerminal(`> GEZEGEN SAYISI: ${Math.floor(Math.random()*8)}`), 1500);
                }
            };
            document.getElementById('ctx-scan-sector').onclick = () => {
                ctxMenu.style.display = 'none';
                playSoundEffect('sector_scan');
                logToTerminal(`B√ñLGE TARANIYOR...`, 'analysis');
                setTimeout(() => logToTerminal(`> KARANLIK MADDE: %${Math.floor(Math.random()*100)}`), 600);
                setTimeout(() => logToTerminal(`> ARKA PLAN RADYASYONU: NORMAL`), 1200);
                setTimeout(() => logToTerminal(`> Sƒ∞NYAL KAYNAƒûI: YOK`), 1800);
            };
            document.getElementById('ctx-mark-coord').onclick = () => {
                 ctxMenu.style.display = 'none';
                 logToTerminal(`KOORDƒ∞NATLAR KAYDEDƒ∞LDƒ∞.`, 'highlight');
            };
            document.getElementById('ctx-cancel').onclick = () => {
                ctxMenu.style.display = 'none';
            };

            document.addEventListener('keydown', (e) => { if(e.key === 'c' || e.key === 'C') toggleCinemaMode(); });
            
            document.getElementById('global-toggle-btn').onclick = toggleCinemaMode;
            document.getElementById('btn-init').onclick = startExperience;
            document.getElementById('btn-warp').onclick = toggleWarp;
            document.getElementById('btn-hide').onclick = toggleCinemaMode;
            document.getElementById('btn-mute').onclick = toggleAudio;

            document.getElementById('btn-nav').onclick = () => setMode('nav');
            document.getElementById('btn-scan').onclick = () => setMode('scan');

            document.getElementById('btn-top').onclick = () => setView('top');
            document.getElementById('btn-side').onclick = () => setView('side');
            document.getElementById('btn-core').onclick = () => setView('core');
            
            const btnFree = document.getElementById('btn-free');
            if(btnFree) btnFree.onclick = () => { setView('free'); controls.reset(); };

            animate();
        }

        function startExperience() {
            document.getElementById('start-screen').style.opacity = 0;
            setTimeout(() => document.getElementById('start-screen').remove(), 800);
            initAudio();
            targetCameraPos.set(6, 5, 8); 
            setMode('scan');
            createNewMission();
        }

        // --- DOKULAR ---
        function getStarTexture() {
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(0.2,'rgba(255,255,255,0.8)'); g.addColorStop(0.5,'rgba(255,255,255,0.2)'); g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32); return new THREE.CanvasTexture(c);
        }
        function getCometTexture() {
            const c = document.createElement('canvas'); c.width=64; c.height=16;
            const ctx = c.getContext('2d');
            const g = ctx.createLinearGradient(0,8,64,8);
            g.addColorStop(0, 'rgba(255,255,255,1)'); g.addColorStop(0.2, 'rgba(0,243,255,0.8)'); g.addColorStop(1, 'rgba(0,0,0,0)'); 
            ctx.fillStyle=g; ctx.fillRect(0,0,64,16); return new THREE.CanvasTexture(c);
        }
        function getNebulaTexture() {
            const c = document.createElement('canvas'); c.width=64; c.height=64;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(32,32,0,32,32,32);
            g.addColorStop(0,'rgba(255,255,255,0.1)'); g.addColorStop(0.6,'rgba(255,255,255,0.02)'); g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,64,64); return new THREE.CanvasTexture(c);
        }
        function getStreakTexture() {
            const c = document.createElement('canvas'); c.width=64; c.height=16;
            const ctx = c.getContext('2d');
            const g = ctx.createLinearGradient(0,8,64,8);
            g.addColorStop(0, 'rgba(255,255,255,0)'); g.addColorStop(0.5, 'rgba(255,255,255,0.8)'); g.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,64,16); return new THREE.CanvasTexture(c);
        }

        // --- G√ñREV Sƒ∞STEMƒ∞ ---
        function createNewMission() {
            const types = ['M (KIZIL)', 'O (MAVƒ∞)', 'G (SARI)'];
            const targetType = types[Math.floor(Math.random() * types.length)];
            currentMission = { targetType: targetType, description: `TARAMA G√ñREVƒ∞: Bir ${targetType} yƒ±ldƒ±z bul.` };
            elMissionDesc.innerText = currentMission.description;
            elMissionDesc.style.color = "#fff";
            logToTerminal(`YENƒ∞ G√ñREV ALINDI: ${targetType} Bul`, 'highlight');
        }

        function checkMissionCompletion(starClass) {
            if (!currentMission) return;
            if (starClass === currentMission.targetType) {
                playSoundEffect('success');
                elOverlay.innerText = "G√ñREV BA≈ûARILI!"; elOverlay.style.color = "var(--gold)"; elOverlay.style.opacity = 1;
                setTimeout(() => { elOverlay.style.opacity = 0; elOverlay.style.color = "#fff"; }, 2000);
                logToTerminal(`G√ñREV TAMAMLANDI: ${starClass}`, 'mission-update');
                playerRank++; updateRankUI(); setTimeout(createNewMission, 3000);
            }
        }
        function updateRankUI() {
            let rankTitle = ranks[Math.min(playerRank - 1, ranks.length - 1)];
            elPlayerRank.innerText = `R√úTBE: ${rankTitle} (SEVƒ∞YE ${playerRank})`;
        }
        function logToTerminal(text, type = '') {
            const div = document.createElement('div'); div.className = 'term-line ' + type; div.innerText = `> ${text}`;
            elTerminal.prepend(div); if(elTerminal.children.length > 12) elTerminal.lastChild.remove();
        }
        function updateTerminal() {
            if(Math.random() > 0.1) return;
            const div = document.createElement('div'); div.className = 'term-line'; div.style.opacity = 0.5;
            const rand = Math.random();
            if(rand > 0.98) div.innerText = `[Sƒ∞STEM] Veri Akƒ±≈üƒ±: ${Math.floor(Math.random()*999)} Mb/s`;
            else { let code = "RX-"; for(let i=0; i<6; i++) code += "0123456789ABCDEF"[Math.floor(Math.random()*16)]; div.innerText = code; }
            elTerminal.prepend(div); if(elTerminal.children.length > 15) elTerminal.lastChild.remove();
        }

        // --- OLU≈ûTURUCULAR ---
        function createGalacticCore() {
            const geo = new THREE.SphereGeometry(0.5, 32, 32); const mat = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const bh = new THREE.Mesh(geo, mat); scene.add(bh);
            const geoRing = new THREE.RingGeometry(0.6, 2.5, 64);
            const matRing = new THREE.MeshBasicMaterial({ color: 0xffaa00, side: THREE.DoubleSide, transparent: true, opacity: 0.4, blending: THREE.AdditiveBlending });
            const ring = new THREE.Mesh(geoRing, matRing); ring.rotation.x = Math.PI / 2; scene.add(ring);
            const spriteMat = new THREE.SpriteMaterial({ map: getStarTexture(), color: 0xff5500, transparent: true, blending: THREE.AdditiveBlending, opacity: 1 });
            coreGlow = new THREE.Sprite(spriteMat); coreGlow.scale.set(6, 6, 1); scene.add(coreGlow);
        }
        function createGalaxy() {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(params.count * 3); const colors = new Float32Array(params.count * 3);
            const colorInside = params.insideColor; const colorOutside = params.outsideColor;
            for(let i=0; i<params.count; i++){
                const i3 = i*3;
                const r = Math.random() * params.radius;
                const spinAngle = r * params.spin;
                const branchAngle = (i % params.branches) / params.branches * Math.PI * 2;
                const rndX = Math.pow(Math.random(), params.randomnessPower) * (Math.random()<0.5?1:-1) * params.randomness * r;
                const rndY = Math.pow(Math.random(), params.randomnessPower) * (Math.random()<0.5?1:-1) * params.randomness * r;
                const rndZ = Math.pow(Math.random(), params.randomnessPower) * (Math.random()<0.5?1:-1) * params.randomness * r;
                positions[i3] = Math.cos(branchAngle + spinAngle) * r + rndX;
                positions[i3+1] = rndY * 0.5; positions[i3+2] = Math.sin(branchAngle + spinAngle) * r + rndZ;
                const mixedColor = colorInside.clone(); mixedColor.lerp(colorOutside, r / params.radius);
                colors[i3] = mixedColor.r * 1.5; colors[i3+1] = mixedColor.g * 1.5; colors[i3+2] = mixedColor.b * 1.5;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            const material = new THREE.PointsMaterial({ size: params.size, sizeAttenuation: true, depthWrite: false, blending: THREE.AdditiveBlending, vertexColors: true, map: getStarTexture(), transparent: true });
            galaxyPoints = new THREE.Points(geometry, material); scene.add(galaxyPoints);
        }
        function createNebula() {
            const geometry = new THREE.BufferGeometry(); const positions = new Float32Array(params.nebulaCount * 3); const colors = new Float32Array(params.nebulaCount * 3);
             for(let i=0; i<params.nebulaCount; i++){
                const i3 = i*3; const r = Math.random() * params.radius * 1.2; const spinAngle = r * params.spin; const branchAngle = (i % params.branches) / params.branches * Math.PI * 2;
                const rndX = (Math.random()-0.5) * 2 * r * 0.5; const rndY = (Math.random()-0.5) * 2 * 0.5; const rndZ = (Math.random()-0.5) * 2 * r * 0.5;
                positions[i3] = Math.cos(branchAngle + spinAngle) * r + rndX; positions[i3+1] = rndY; positions[i3+2] = Math.sin(branchAngle + spinAngle) * r + rndZ;
                const color = new THREE.Color(); color.setHSL(Math.random() * 0.2 + 0.5, 0.8, 0.5);
                colors[i3] = color.r; colors[i3+1] = color.g; colors[i3+2] = color.b;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            const material = new THREE.PointsMaterial({ size: 0.5, map: getNebulaTexture(), depthWrite: false, blending: THREE.AdditiveBlending, vertexColors: true, transparent: true, opacity: 0.05 });
            nebulaPoints = new THREE.Points(geometry, material); scene.add(nebulaPoints);
        }
        function createBackgroundStars() {
            const geometry = new THREE.BufferGeometry(); const positions = new Float32Array(2000 * 3);
            for(let i=0; i<2000; i++){
                const r = 50 + Math.random() * 30; const theta = Math.random() * Math.PI * 2; const phi = Math.acos(2 * Math.random() - 1);
                positions[i*3] = r * Math.sin(phi) * Math.cos(theta); positions[i*3+1] = r * Math.sin(phi) * Math.sin(theta); positions[i*3+2] = r * Math.cos(phi);
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); const material = new THREE.PointsMaterial({ color: 0x444444, size: 0.15, transparent: true, map: getStarTexture() });
            bgStars = new THREE.Points(geometry, material); scene.add(bgStars);
        }
        function createWarpStreaks() {
            const geometry = new THREE.BufferGeometry(); const positions = new Float32Array(params.warpStarCount * 3); const initialPositions = new Float32Array(params.warpStarCount * 3);
            for(let i=0; i<params.warpStarCount; i++){
                const i3 = i*3; const r = 10 + Math.random() * 30; const theta = Math.random() * Math.PI * 2; const phi = Math.acos(2 * Math.random() - 1);
                const x = r * Math.sin(phi) * Math.cos(theta); const y = r * Math.sin(phi) * Math.sin(theta); const z = r * Math.cos(phi);
                positions[i3] = x; positions[i3+1] = y; positions[i3+2] = z; initialPositions[i3] = x; initialPositions[i3+1] = y; initialPositions[i3+2] = z;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); geometry.setAttribute('initialPos', new THREE.BufferAttribute(initialPositions, 3));
            const material = new THREE.PointsMaterial({ size: 0.8, map: getStreakTexture(), color: 0xffffff, transparent: true, opacity: 0, blending: THREE.AdditiveBlending, depthWrite: false });
            warpStreaks = new THREE.Points(geometry, material); scene.add(warpStreaks);
        }
        function createSpaceDust() {
            const geometry = new THREE.BufferGeometry(); const positions = new Float32Array(params.dustCount * 3);
            for(let i=0; i<params.dustCount; i++){
                positions[i*3] = (Math.random() - 0.5) * 25; positions[i*3+1] = (Math.random() - 0.5) * 25; positions[i*3+2] = (Math.random() - 0.5) * 25;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); const mat = new THREE.PointsMaterial({ color:0x888888, size:0.05, transparent:true, opacity:0.3 });
            dustParticles = new THREE.Points(geometry, mat); scene.add(dustParticles);
        }
        function createConnections() {
            const maxLines = 600; const geometry = new THREE.BufferGeometry(); const positions = new Float32Array(maxLines * 2 * 3);
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const material = new THREE.LineBasicMaterial({ color: 0x00ffaa, transparent: true, opacity: 0.2, blending: THREE.AdditiveBlending });
            connectionLines = new THREE.LineSegments(geometry, material); connectionLines.frustumCulled = false; scene.add(connectionLines);
            for(let i=0; i<positions.length; i++) positions[i] = 0;
        }
        function initComets() {
            const geometry = new THREE.BufferGeometry(); const vertices = new Float32Array([0,0,0]); geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ size: 2, map: getCometTexture(), transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, depthWrite: false });
            for(let i=0; i<5; i++) { const comet = new THREE.Points(geometry, material.clone()); resetComet(comet); scene.add(comet); comets.push(comet); }
        }
        function resetComet(comet) {
            const angle = Math.random() * Math.PI * 2; const dist = 20 + Math.random() * 10;
            comet.position.set(Math.cos(angle)*dist, (Math.random()-0.5)*5, Math.sin(angle)*dist);
            const target = new THREE.Vector3((Math.random()-0.5)*5, (Math.random()-0.5)*2, (Math.random()-0.5)*5);
            comet.userData.velocity = target.sub(comet.position).normalize().multiplyScalar(0.05 + Math.random() * 0.1);
        }
        function updateComets() {
            comets.forEach(comet => { comet.position.add(comet.userData.velocity); if(comet.position.length() > 40) resetComet(comet); });
        }

        // --- ANA D√ñNG√ú ---
        function updateWarpEffect() {
            if (!warpStreaks) return;
            const positions = warpStreaks.geometry.attributes.position.array;
            if (isWarping && warpSpeed > 0.01) {
                warpStreaks.material.opacity = warpSpeed; warpStreaks.rotation.z += 0.02 * warpSpeed;
                for(let i=0; i<params.warpStarCount; i++){
                    const i3 = i*3; positions[i3+2] += 3 * warpSpeed; if(positions[i3+2] > 20) positions[i3+2] = -35;
                }
                warpStreaks.geometry.attributes.position.needsUpdate = true; document.body.classList.add('warp-active');
            } else { warpStreaks.material.opacity = 0; document.body.classList.remove('warp-active'); }
        }
        function updateDust() {
            if(!dustParticles) return;
            const positions = dustParticles.geometry.attributes.position.array;
            for(let i=0; i<params.dustCount; i++){
                const i3 = i*3; let speed = isWarping ? 0.8 : 0.003;
                positions[i3+2] += speed; if(positions[i3+2] > 12) positions[i3+2] = -12;
            }
            dustParticles.geometry.attributes.position.needsUpdate = true;
        }
        function updateConnections() {
            if(!lockedTargetPos || isWarping || currentMode === 'nav') {
                connectionLines.visible = false; elNetStatus.innerText = "PASƒ∞F"; return;
            }
            connectionLines.visible = true; elNetStatus.innerText = "ANALƒ∞Z EDƒ∞Lƒ∞YOR...";
            const positions = connectionLines.geometry.attributes.position.array;
            let lineIndex = 0;
            const starPos = galaxyPoints.geometry.attributes.position;
            let count = 0;
            for(let i=0; i<3500; i++) {
                const x = starPos.getX(i); const y = starPos.getY(i); const z = starPos.getZ(i);
                const dist = Math.sqrt(Math.pow(x - lockedTargetPos.x, 2) + Math.pow(y - lockedTargetPos.y, 2) + Math.pow(z - lockedTargetPos.z, 2));
                if(dist < 1.8 && dist > 0.01) {
                    if(lineIndex < 600 * 6) {
                        positions[lineIndex++] = lockedTargetPos.x; positions[lineIndex++] = lockedTargetPos.y; positions[lineIndex++] = lockedTargetPos.z;
                        positions[lineIndex++] = x; positions[lineIndex++] = y; positions[lineIndex++] = z;
                        count++;
                    }
                }
            }
            for(let i=lineIndex; i<positions.length; i++) positions[i] = 0;
            connectionLines.geometry.attributes.position.needsUpdate = true;
            elNetStatus.innerText = `BAƒûLANTI: ${count} D√úƒû√úM`;
        }

        function onMouseMove(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        }
        function onMouseClick(e) {
            if(lockedTargetPos && !isWarping && currentMode === 'scan') {
                // Tƒ±klama sadece ses efekti versin, zƒ±plamayƒ± men√ºye ta≈üƒ±dƒ±k
                playSoundEffect('scan'); 
            }
        }
        function performHyperJump(target) {
            targetCameraPos.copy(target).add(new THREE.Vector3(0.8, 0.4, 0.8));
            controls.target.copy(target);
            playSoundEffect('jump');
            elOverlay.innerText = "HYPER-JUMP"; elOverlay.style.opacity = 1;
            setTimeout(() => elOverlay.style.opacity = 0, 1500);
            const currentStarClass = elScanClass.innerText;
            checkMissionCompletion(currentStarClass);
        }
        function toggleWarp() {
            isWarping = !isWarping;
            const btn = document.getElementById('btn-warp');
            if (isWarping) {
                btn.classList.add('active'); btn.innerText = "DURDUR";
                playSoundEffect('warp_start');
                elOverlay.innerText = "WARP HIZI AKTƒ∞F"; elOverlay.style.opacity = 1; setTimeout(() => elOverlay.style.opacity = 0, 2000);
            } else {
                btn.classList.remove('active'); btn.innerText = "WARP"; camera.fov = 75; camera.updateProjectionMatrix();
            }
        }

        function checkInteractions() {
            // Navigasyon modunda veya obje yoksa i≈ülem yapma
            if (!galaxyPoints || currentMode === 'nav') {
                document.body.style.cursor = 'default';
                elLockMsg.style.opacity = 0;
                lockedTargetPos = null;
                // Flare silindi
                return;
            }

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(galaxyPoints);
            if (intersects.length > 0) {
                const point = intersects[0];
                if (point.distanceToRay < 0.2) {
                    if(elLockMsg.style.opacity == 0) playSoundEffect('scan');
                    document.body.style.cursor = 'pointer';
                    const idx = point.index;
                    elScanId.innerText = `SEC-${2000+idx}`;
                    const temp = 3000 + (idx % 7000);
                    let starClass = 'G (SARI)'; let color = '#ffff00';
                    if(temp > 8000) { starClass = 'O (MAVƒ∞)'; color='#00ffff'; }
                    else if(temp < 4000) { starClass = 'M (KIZIL)'; color='#ff4444'; }
                    elScanClass.innerText = starClass; elScanClass.style.color = color;
                    elScanTemp.innerText = temp + " K"; elScanDist.innerText = point.distance.toFixed(1) + " IY";
                    elLockMsg.style.opacity = 1;
                    lockedTargetPos = new THREE.Vector3(galaxyPoints.geometry.attributes.position.getX(idx), galaxyPoints.geometry.attributes.position.getY(idx), galaxyPoints.geometry.attributes.position.getZ(idx));
                    // Flare silindi
                }
            } else {
                document.body.style.cursor = 'default'; elLockMsg.style.opacity = 0; lockedTargetPos = null;
                // Flare silindi
            }
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            updateAudioEngine(); animateVisualizer(); updateWarpEffect(); updateDust(); updateTerminal(); updateConnections(); updateComets();
            
            if(galaxyPoints) galaxyPoints.rotation.y += 0.0003;
            if(nebulaPoints) nebulaPoints.rotation.y += 0.0002;
            if(bgStars) bgStars.rotation.y -= 0.0001;
            if(coreGlow) coreGlow.rotation.z -= 0.001;

            // Kamera Animasyonu
            if (currentView !== 'free') {
                camera.position.lerp(targetCameraPos, 0.04);
                controls.target.lerp(new THREE.Vector3(0,0,0), 0.04);
                controls.update();
            } else {
                controls.update();
            }

            if (isWarping) {
                warpSpeed = Math.min(warpSpeed + 0.005, 1.0);
                camera.fov = 75 + (warpSpeed * 60); camera.updateProjectionMatrix();
                camera.position.x += (Math.random()-0.5) * 0.03; camera.position.y += (Math.random()-0.5) * 0.03;
            } else {
                warpSpeed = Math.max(warpSpeed - 0.02, 0);
                if (warpSpeed > 0) { camera.fov = 75 + (warpSpeed * 60); camera.updateProjectionMatrix(); }
                checkInteractions();
            }

            composer.render();
        }

        init();
    </script>
</body>
</html>